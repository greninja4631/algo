<<<<<<< HEAD
<<<<<<< HEAD
/**
 * @file    tests/util/test_metrics.c
 * @brief   util/metrics ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
 * @note    main() ã¯ tests/test_main.c ã«é›†ç´„ã•ã‚Œã‚‹
 */

#include "util/test_metrics.h"   /* void test__metrics_basic(void); */
#include "util/metrics.h"        /* è¢«ãƒ†ã‚¹ãƒˆ API */
#include "util/logger.h"         /* ds_log() & DS_LOG_LEVEL_*      */

/* ã‚°ãƒ­ãƒ¼ãƒãƒ« DI ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ï¼ˆå¿…è¦ãªã‚‰ï¼‰  */
extern const ds_allocator_t *g_alloc;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* å…±é€šã‚¢ã‚µãƒ¼ãƒˆãƒ»ãƒã‚¯ãƒ­            */
#define DS_TEST_ASSERT(cond, msg)                                           \
    do {                                                                    \
        if (cond) { ds_log(DS_LOG_LEVEL_INFO,  "[PASS] %s", (msg)); }       \
        else      { ds_log(DS_LOG_LEVEL_ERROR, "[FAIL] %s (%s:%d)",         \
                           (msg), __FILE__, __LINE__); }                    \
    } while (0)

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* åŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆ                  */
void test__metrics_basic(void)
{
    /* 1. å…¨ãƒªã‚»ãƒƒãƒˆ (@side-effect: global) */
    ds_metrics_reset_all(g_alloc);
=======
ã€€ä¸Šè¨˜ã‚’ãƒ‘ãƒƒãƒå½¢å¼ã§ã¯ãªãã€ğŸ“š Cãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ APIè¨­è¨ˆãƒ»å®Ÿè£… å®Œå…¨çµ±ä¸€ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
ä¸Šè¨˜ã¨ä¸‹è¨˜ã®ã‚’æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚ã¦ã€è‰¯ã„éƒ¨åˆ†ã‚’æ®‹ã—ã€æ‚ªã„éƒ¨åˆ†ã‚’å‰Šé™¤ã—ã¦çœç•¥ã›ãšã«ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’å³æ ¼ã«å®ˆã£ã¦ã‚³ãƒ¼ãƒ‰ã‚’å†ç”Ÿæˆã—ã¦ä¸‹ã•ã„ã€‚ã€€ã€€ã€€
=======
ã€€ä¸Šè¨˜ã‚’ãƒ‘ãƒƒãƒå½¢å¼ã§ã¯ãªãã€ä¸Šè¨˜ã¨ä¸‹è¨˜ã®ã‚’æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚ã¦ã€è‰¯ã„éƒ¨åˆ†ã‚’æ®‹ã—ã€æ‚ªã„éƒ¨åˆ†ã‚’å‰Šé™¤ã—ã¦çœç•¥ã›ãšã«ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’å³æ ¼ã«å®ˆã£ã¦ã‚³ãƒ¼ãƒ‰ã‚’å†ç”Ÿæˆã—ã¦ä¸‹ã•ã„ã€‚ã€€ã€€ã€€
>>>>>>> feature

(2025-07 æ”¹è¨‚ç‰ˆ â€” ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢å·¥å­¦ã®æœ€å‰ç·š + ç¾å ´å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå®Œå…¨çµ±åˆç‰ˆ)




0. ç›®çš„ã¨é©ç”¨ç¯„å›²
	â€¢	src/, include/, tests/ ä»¥ä¸‹ã«ç½®ã‹ã‚Œã‚‹ ã™ã¹ã¦ã® C ã‚³ãƒ¼ãƒ‰ ã¨ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
	â€¢	CI/CDï¼ˆDocker å†…ã§èµ°ã‚‰ã›ã‚‹ã‚·ã‚§ãƒ« / Jenkinsfile / GitHub Actionsï¼‰ã‚‚å«ã‚€ã€‚

<<<<<<< HEAD
<<<<<<< HEAD
#	åŸå‰‡	è¦æ—¨
0-1	ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ DI çµ±ä¸€	ã™ã¹ã¦ã®å…¬é–‹ API ã®ç¬¬ 1 å¼•æ•°ã¯const ds_allocator_t *allocå›ºå®šã€‚alloc==NULLæ™‚ã¯ ds_malloc/ds_freeã¸è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
0-2	calloc/free å®‰å…¨è¨­è¨ˆ	_std_allocã¯ã€Œcnt==0â†’NULLã€ã€_std_freeã¯ã€Œp==NULLâ†’no-opã€ã€‚æœ¬ç•ª/ãƒ†ã‚¹ãƒˆã„ãšã‚Œã‚‚ free(NULL) ãŒå¿…ãšå®‰å…¨ã€‚
0-3	NULL ã‚»ãƒ¼ãƒ• API	ã‚ã‚‰ã‚†ã‚‹ API ã¯ NULL ã‚’â¾®è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã„ DS_ERR_NULL_POINTER ã‚’è¿”ã™ â€“ CI ã§ NULL deref ãŒç„¡ã„ã“ã¨ã‚’ä¿è¨¼ã€‚
0-4	å‘½åãƒ»out_ãƒ»@ownership çµ±ä¸€	å‘½åãƒ«ãƒ¼ãƒ«ã¯ Â§1ã€å‡ºåŠ›å¼•æ•°ã¯ å¿…ãš out_ ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹ã€ãƒ¡ãƒ¢ãƒªæ‰€æœ‰æ¨©ã¯ Doxygen @ownership ã‚’ 100 % æ˜ç¤ºã€‚
0-5	ç ´æ£„ã¯ 1 å›ã ã‘	ã©ã®ãƒªã‚½ãƒ¼ã‚¹ã‚‚ äºŒé‡ free ç¦æ­¢ã€‚destroy/reset/clear ãªã©ç ´æ£„ç³»åˆ— API ã¯ free æ¸ˆãƒã‚¤ãƒ³ã‚¿ã‚’ NULL ã¸ã‚»ãƒƒãƒˆã—å†åˆ©ç”¨ä¸å¯ã«ã™ã‚‹ã€‚
0-6	æ§‹é€ ä½“æœ¬ä½“ã¯ .c	DTO ä¾‹å¤–ã‚’é™¤ã æ§‹é€ ä½“æœ¬ä½“ã¯ .c ãƒ•ã‚¡ã‚¤ãƒ« 1 ã‹æ‰€ã®ã¿ã€‚ãƒ˜ãƒƒãƒ€ã§ãƒ¡ãƒ³ãƒå…¬é–‹ç¦æ­¢ã€‚
0-7	ãƒ­ã‚° 6 æ®µ + ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³	ãƒ­ã‚°ã¯ TRACE/DEBUG/INFO/WARN/ERROR/FATAL ã® 6 æ®µã€ã‚¢ã‚µãƒ¼ãƒˆã¯ DS_TEST_ASSERT / TASSERT çµ±ä¸€ã€‚
0-8	ãƒ†ã‚¹ãƒˆ main() åˆ†é›¢	å„ãƒ†ã‚¹ãƒˆã¯ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³å®Ÿè¡Œå¯èƒ½ã ãŒã€å®Ÿéš›ã® CI ãƒ©ãƒ³ã¯ tests/test_main.c ãŒä¸€æ‹¬å‘¼ã³å‡ºã—ã€‚
0-9	Valgrind & æ‹¡å¼µå®¹æ˜“æ€§	ã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ Valgrind â€œdefinitely lostâ€ = 0 ã‚’ CI ã§ä¿è¨¼ã—ã€å¾Œæ–¹äº’æ›ã‚’å£Šã•ãšæ‹¡å¼µã§ãã‚‹è¨­è¨ˆã«ã™ã‚‹ã€‚
>>>>>>> feature
=======
â¸»
=======
>>>>>>> feature

1. ã‚³ã‚¢åŸå‰‡ï¼ˆã€Œå®ˆã‚‰ãªã„ã¨ãƒ“ãƒ«ãƒ‰ or CI ãŒå³è½ã¡ã‚‹ã€ãƒ¬ãƒ™ãƒ«ï¼‰

ID	åŸå‰‡å	å…·ä½“ãƒ«ãƒ¼ãƒ«ï¼ˆæ›–æ˜§ã•ã‚¼ãƒ­ã§è¨˜è¿°ï¼‰	ç†ç”± / åŠ¹æœ
0-1	ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ DI çµ±ä¸€	å…¬é–‹ API ã® ç¬¬ 1 å¼•æ•°ã¯ const ds_allocator_t *alloc ã«å›ºå®šã€‚ alloc == NULL ã®å ´åˆã¯ ds_malloc/ds_free/ds_realloc ãŒæš—é»™ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚	ãƒ»ãƒ†ã‚¹ãƒˆæ™‚ã«ãƒ¢ãƒƒã‚¯ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã‚’æ³¨å…¥ã§ãã‚‹ã€‚ãƒ»ãƒ¡ãƒ¢ãƒªå‡ºå£ã‚’ 1 ã‹æ‰€ã«é›†ç´„ã§ãã‚‹ã€‚
0-2	calloc/free å®‰å…¨è¨­è¨ˆ	_std_alloc(cnt,sz) ã¯ cnt == 0 ã§ NULL ã‚’è¿”ã™ã€‚_std_free(p) ã¯ p == NULL ã§ no-opã€‚	â€œã‚¼ãƒ­ãƒã‚¤ãƒˆç¢ºä¿â€ã‚„ â€œfree(NULL)â€ ã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„ã€‚
0-3	NULL ã‚»ãƒ¼ãƒ• API	ã©ã® API ã‚‚ NULL ã‚’è‡´å‘½çš„ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã«ã—ãªã„ã€‚å¿…ãš DS_ERR_NULL_POINTER ã‚’è¿”ã™ã€‚	NULL-deref ã‚’ CI ã§ã‚¼ãƒ­ã«ä¿ã¤ã€‚
0-4	å‘½åãƒ»@ownership çµ±ä¸€	å‡ºåŠ›ãƒã‚¤ãƒ³ã‚¿ã¯ã™ã¹ã¦ out_ ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹ã€‚Doxygen ã® @ownership ã¯ caller frees / callee frees / transfer ã® 3 æŠã‚’å¿…ãšä»˜ã‘ã‚‹ã€‚	äººé–“ãƒ»é™çš„è§£æãƒ„ãƒ¼ãƒ«ãŒæ‰€æœ‰æ¨©ã‚’èª¤è§£ã—ãªã„ã€‚
0-5	ç ´æ£„ã¯ 1 å›ã ã‘	destroy/reset ç³» API ã¯ã€å†…éƒ¨ã§ free å¾Œ ãƒã‚¤ãƒ³ã‚¿ã‚’ NULL ã¸ã€‚äºŒé‡ free ãŒèµ·ãã¦ã‚‚ no-opã€‚	äºŒé‡ free ãƒã‚°å®Œå…¨é˜²æ­¢ã€‚
0-6	æ§‹é€ ä½“æœ¬ä½“ã¯ .c	DTO ã‚’é™¤ãã€ãƒ¡ãƒ³ãƒå®£è¨€ã¯ .c ãƒ•ã‚¡ã‚¤ãƒ« 1 ç®‡æ‰€ã®ã¿ã€‚ãƒ˜ãƒƒãƒ€ã¯ forward-decl ã®ã¿ã€‚	ABI å¤‰æ›´ãŒãƒ˜ãƒƒãƒ€ã«æ³¢åŠã—ãªã„ã€‚
0-7	ãƒ­ã‚° 6 æ®µ	`ds_log(TRACE	DEBUG
0-8	ãƒ†ã‚¹ãƒˆ main åˆ†é›¢	å€‹åˆ¥ test ãƒ•ã‚¡ã‚¤ãƒ«ã¯ #ifdef DS_STANDALONE_TEST æ™‚ã®ã¿ main() ã‚’æŒã¤ã€‚CI ã§ã¯ tests/test_main.c ãŒå…¨ãƒ†ã‚¹ãƒˆã‚’é›†ç´„ã€‚	å˜ä½“å®Ÿè¡Œã¨ CI å®Ÿè¡Œã®ä¸¡ç«‹ã€‚
0-9	Valgrind 0 æ¼ã‚Œ	CI ã® valgrind --leak-check=full ã§ â€œdefinitely lostâ€ = 0 ã‚’å¼·åˆ¶ã€‚	ãƒªãƒ¼ã‚¯ã‚’æ—©æœŸã«æ½°ã™ã€‚
>>>>>>> feature

    /* 2. ã‚«ã‚¦ãƒ³ã‚¿åŠ ç®— */
    ds_metrics_increment(g_alloc, "test.counter");
    ds_metrics_increment(g_alloc, "test.counter");
    int64_t v = ds_metrics_get(g_alloc, "test.counter");
    DS_TEST_ASSERT(v == 2, "test.counter == 2");

    /* 3. åˆ¥ã‚«ã‚¦ãƒ³ã‚¿ */
    ds_metrics_increment(g_alloc, "other");
    DS_TEST_ASSERT(ds_metrics_get(g_alloc, "other") == 1, "other == 1");

<<<<<<< HEAD
<<<<<<< HEAD
    /* 4. åˆè¨ˆãƒã‚§ãƒƒã‚¯ï¼ˆget_total API ãŒç„¡ã„å ´åˆã¯å€‹åˆ¥é›†è¨ˆï¼‰ */
    int64_t total =
        ds_metrics_get(g_alloc, "test.counter") +
        ds_metrics_get(g_alloc, "other");
    DS_TEST_ASSERT(total == 3, "total == 3");

    ds_log(DS_LOG_LEVEL_INFO, "[OK] test__metrics_basic å®Œäº†");
}
=======
1. å‘½åè¦ç´„ & å‹è¨­è¨ˆãƒ«ãƒ¼ãƒ«ï¼ˆè¶…è©³ç´°ç‰ˆï¼‰
=======
2. å‘½åè¦ç´„ãƒ»å‹è¨­è¨ˆï¼ˆIDE è£œå®Œ & ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã«å¼·ã„ï¼‰
	1.	æ§‹é€ ä½“æœ¬ä½“
>>>>>>> feature

// src/ds/stack.c ã®ã¿
struct ds_stack { â€¦ };


	2.	å‰æ–¹å®£è¨€ typedef

/* include/data_structures.h */
typedef struct ds_stack ds_stack_t;

ã™ã¹ã¦ã® typedef ã‚’ 1 ãƒ•ã‚¡ã‚¤ãƒ«ã«é›†ä¸­ã•ã›ã‚‹ã“ã¨ã§å¤šé‡å®šç¾©ã‚’æ’é™¤ã€‚

	3.	é–¢æ•°å‘½åâ€ƒds_stack_create() / ds_stack_push() â€¦ å‹•è©å¿…é ˆ
	4.	ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰â€ƒDS_ERR_STACK_OVERFLOW
	5.	getter/setterâ€ƒds_stack_get_size() / ds_stack_set_limit()
	6.	cloneâ€ƒds_stack_clone(const ds_stack_t *src) ã¯å¿…ãšæ·±ã„ã‚³ãƒ”ãƒ¼

â¸»

3. å¥‘ç´„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°

/**
 * @pre  alloc != NULL
 * @pre  out_stack != NULL
 * @post *out_stack != NULL
 */
ds_error_t ds_stack_create(const ds_allocator_t *alloc,
                           ds_stack_t          **out_stack)
{
    assert(alloc && out_stack);
    â€¦
}

	â€¢	assert() ã§ é–‹ç™ºæ™‚ã«å³ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã€ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰ã§ã¯æˆ»ã‚Šå€¤ã§é€šçŸ¥ã€‚
	â€¢	@pre/@post ã‚³ãƒ¡ãƒ³ãƒˆã‚’ Doxygen ã§ç”Ÿæˆ â†’ CI ã§æ¬ è½ã‚’æ¤œå‡ºã€‚

â¸»

4. æŠ½è±¡ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ DI â€• å®Ÿè£…ãƒã‚§ãƒƒã‚¯æ‰‹é †
	1.	ç¦æ­¢ API æ¤œå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ

grep -R --include='*.c' --include='*.h' -n \
  '\b\(malloc\|calloc\|realloc\|free\)\b' src/ include/ \
  | grep -v 'ds_malloc\|ds_free\|ds_realloc' \
  && { echo 'Forbidden malloc/free detected'; exit 1; }


	2.	ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…ï¼ˆæŠœç²‹ï¼‰

static void* _std_alloc(size_t n,size_t sz){ return n?calloc(n,sz):NULL; }
static void  _std_free (void* p){ if(p) free(p); }



â¸»

5. ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

include/
â”œ data_structures.h         # typedef é›†ä¸­
â”” ds/
   â”” stack.h                # API ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã®ã¿
src/ds/
â”” stack.c                   # å®Ÿè£… + æ§‹é€ ä½“æœ¬ä½“
tests/
â”œ include/ds/               # ãƒ†ã‚¹ãƒˆç”¨ stub
â”” ds/                       # ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

ãƒ«ãƒ¼ãƒ«ï¼šãƒ“ãƒ«ãƒ‰æˆæœç‰©ãƒ».bak ãªã©ã¯ .gitignoreã€‚

â¸»

6. ãƒ­ã‚° & æ§‹é€ åŒ–ãƒ­ã‚°ï¼ˆæ‹¡å¼µã‚¿ã‚¹ã‚¯ï¼‰
ã€€ã€€ â€¢ â€œDocker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ run_ci.sh ã‚’å®Ÿè¡Œã™ã‚‹â€ ã¨ã„ã†ä¸€æ–‡ã‚’è¿½åŠ ã€‚
	â€¢	æœ€å°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼šlevel|timestamp|module|message
	â€¢	å°†æ¥çš„ã« json ãƒ¢ãƒ¼ãƒ‰ã‚’ ds_set_log_function() ã§å·®ã—æ›¿ãˆ â†’ ELK ã§è§£æã€‚

â¸»

7. CI/CD & ãƒ“ãƒ«ãƒ‰ãƒ•ãƒ©ã‚°

CFLAGS = -Wall -Wextra -Werror -pedantic -std=c11 \
         -D_FORTIFY_SOURCE=2 -fstack-protector-strong -O2 -g

CI æ‰‹é †è¦ç‚¹
	1.	make build
	2.	cppcheck --error-exitcode=1
	3.	clang-tidy (-warnings-as-errors=*)
	4.	make test
	5.	valgrind --leak-check=full
	6.	ç¦æ­¢ API grep (å‰è¿°)

Docker ã‚³ãƒ³ãƒ†ãƒŠã§å®Ÿè¡Œã—ã€ç’°å¢ƒå·®ã‚’æ’é™¤ã€‚

â¸»

8. æ—¢å­˜ã‚³ãƒ¼ãƒ‰ç§»è¡Œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆPR Before-Mergeï¼‰

ãƒã‚§ãƒƒã‚¯é …ç›®	Yes / No
typedef ãŒ data_structures.h ã«é›†ç´„ã•ã‚Œã¦ã„ã‚‹	
å…¬é–‹ API ãŒ alloc ã‚’ç¬¬ 1 å¼•æ•°ã«æŒã¤	
ç›´ malloc/free ãŒ 0 è¡Œ (grep æ¸ˆ)	
æ§‹é€ ä½“æœ¬ä½“ãŒ .c ã®ã¿	
ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚¼ãƒ­ (ä¾‹å¤–ã¯ Mutex/TLS ä¿è­·)	
clone() å®Ÿè£…ï¼ˆå¿…è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ï¼‰	
ãƒ˜ãƒƒãƒ€ã§ @ownership æ˜è¨˜æ¸ˆã¿	
ãƒ†ã‚¹ãƒˆå test__<module>_<case>() å½¢å¼	
Valgrind â€œdefinitely lostâ€ = 0	


â¸»

9. ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ¤œå‡ºï¼å³ Failï¼‰
	â€¢	æ§‹é€ ä½“æœ¬ä½“ã‚’ãƒ˜ãƒƒãƒ€ã«æ›¸ã„ã¦å†å®šç¾©
	â€¢	ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µã§æœ¬ç•ªãƒ˜ãƒƒãƒ€ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
	â€¢	æœ¬ç•ªã‚³ãƒ¼ãƒ‰ã« printf/puts/perror ç³»
	â€¢	goto fail; ã‚¹ãƒ‘ã‚²ãƒ†ã‚£

â¸»

<<<<<<< HEAD
11. çµ¶å¯¾ NG ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³
	â€¢	å‹å¤šé‡å®šç¾© / æ§‹é€ ä½“æœ¬ä½“ã®ãƒ˜ãƒƒãƒ€é‡è¤‡
	â€¢	ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µã§æœ¬ç•ªãƒ˜ãƒƒãƒ€ã‚’åˆ‡æ›¿
	â€¢	æœ¬ç•ªã‚³ãƒ¼ãƒ‰ã§ printf / perror / fprintf(stderr, â€¦)
	â€¢	ã‚¹ãƒ‘ã‚²ãƒ†ã‚£ãª goto fail; å¤šç”¨
>>>>>>> feature
=======
10. æ‹¡å¼µãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆå„ªå…ˆé †ä½ã¤ãã‚¿ã‚¹ã‚¯ï¼‰
	1.	ãƒ˜ãƒ«ãƒ‘ / stack.c ãªã©æ®‹ã‚‹ç›´ malloc ã‚’ grep â†’ ä¿®æ­£
	2.	å…¨ API ã«å¥‘ç´„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å°å…¥ (@pre/@post)
	3.	ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ DS (_Generic + copy/compare)
	4.	ã‚¹ãƒ¬ãƒƒãƒ‰å®‰å…¨ç‰ˆ DSï¼ˆmutex / lock-freeï¼‰
	5.	ãƒ¡ãƒ¢ãƒªãƒ—ãƒ¼ãƒ« API (ds_pool_alloc) + ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
	6.	ds_error_t ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ¼ãƒ–ãƒ« + ds_strerror()
	7.	æ§‹é€ åŒ–ãƒ­ã‚° JSON â†’ ELK é€£æº
	8.	Jenkins CI/CD å®Œå…¨è‡ªå‹•åŒ–
	9.	gcovr ã‚«ãƒãƒ¬ãƒƒã‚¸ 80%â†‘, Fuzzing, MISRA-C é™çš„è§£æ
	10.	å½¢å¼æ‰‹æ³• (Frama-C / CBMC) Nightly å®Ÿè¡Œ

å„ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ç‚¹ã§ ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’éƒ½åº¦æ›´æ–°ã—ã€CI ã«ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹ã€‚

â¸»

11. å‚è€ƒå®Ÿè£…ã‚¹ãƒ‹ãƒšãƒƒãƒˆ

11-1. ã‚¹ã‚¿ãƒƒã‚¯ç”Ÿæˆ API å®Œå…¨ç‰ˆ

/**
 * @brief    ã‚¹ã‚¿ãƒƒã‚¯ç”Ÿæˆ
 * @pre      alloc != NULL
 * @pre      out_stack != NULL
 * @post     *out_stack != NULL
 * @ownership caller frees (ds_stack_destroy)
 */
ds_error_t ds_stack_create(const ds_allocator_t *alloc,
                           ds_stack_t          **out_stack)
{
    assert(alloc && out_stack);

    ds_stack_t *s = ds_malloc(alloc, 1, sizeof *s);
    if (!s) return DS_ERR_ALLOC;

    s->alloc = alloc;
    s->size  = 0;
    s->cap   = 16;
    s->data  = ds_malloc(alloc, s->cap, sizeof(void*));
    if (!s->data) { ds_free(alloc, s); return DS_ERR_ALLOC; }

    *out_stack = s;
    return DS_SUCCESS;
}


â¸»
11-2. CI/CD å®Ÿè¡Œæ–¹æ³•ï¼ˆrun_ci.sh æ¡ç”¨ï¼‰

â— åŸå‰‡  
  Jenkinsï¼GitHub Actionsï¼GitLab CI ç­‰ã®ä¸Šä½ãƒ„ãƒ¼ãƒ«ã¯  
  ã€ŒDocker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ run_ci.sh ã‚’ 1 è¡Œå®Ÿè¡Œã™ã‚‹ã€ã ã‘ã§ã‚ˆã„ã€‚

â— æ‰‹é †  
  - Jenkinsfile ä¾‹
      pipeline {
        agent any
        stages {
          stage('CI') {
            steps {
              sh 'chmod +x ./run_ci.sh && ./run_ci.sh'
            }
          }
        }
      }

  - GitHub Actions ä¾‹ (.github/workflows/ci.yml)
      jobs:
        build:
          runs-on: ubuntu-latest
          steps:
            - uses: actions/checkout@v4
            - run: chmod +x ./run_ci.sh && ./run_ci.sh

â— run_ci.sh ã®è²¬å‹™  
  1) make clean / make build  
  2) clang-tidy ï¼‹ cppcheckï¼ˆè­¦å‘Šâ†’ã‚¨ãƒ©ãƒ¼ï¼‰  
  3) ç¦æ­¢ API grepï¼ˆmalloc/calloc/realloc/free ç›´å‘¼ã³ã‚¼ãƒ­ï¼‰  
  4) ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ  
  5) Valgrind --leak-check=full (definitely lost = 0)  
  6) ç”Ÿæˆç‰©ä¸€è¦§ï¼Doxygenï¼ã‚«ãƒãƒ¬ãƒƒã‚¸ (ä»»æ„)  
  7) ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯éã‚¼ãƒ­çµ‚äº†ã§ CI Fail

â— é‡è¦ãƒã‚¤ãƒ³ãƒˆ  
  - CI ãƒ„ãƒ¼ãƒ«å›ºæœ‰ã® YAMLï¼Groovy ã¯ â€œrun_ci.sh ã‚’å‘¼ã¶ã ã‘â€ ã«æŠ‘ãˆã€  
    ã™ã¹ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚’ **run_ci.sh å´**ã§ä¸€å…ƒç®¡ç†ã™ã‚‹ã€‚  
  - ã“ã‚Œã«ã‚ˆã‚Šè¤‡æ•° CI ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é–“ã§å“è³ªæ¡ä»¶ãŒãšã‚Œãªã„ã€‚
<<<<<<< HEAD
>>>>>>> feature
=======


  ã¯ã„ã€ã‚ãªãŸãŒæç¤ºã•ã‚ŒãŸå†…å®¹ã¯ã™ã§ã«æ¥µã‚ã¦å®Œæˆåº¦ãŒé«˜ãã€å®Ÿéš›ã«ä¸–ç•Œæ°´æº–ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢å·¥å­¦ãƒ»Cã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆãƒ»CSã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã®åŸºç¤ã¨ã—ã¦ååˆ†ã«æ©Ÿèƒ½ã—ã¾ã™ã€‚

ãŸã ã—ã€**â€œå®Œç’§â€**ã¨ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®è¦³ç‚¹ã‚’æœ€çµ‚è£œå¼·ã¨ã—ã¦è¿½åŠ ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ï¼š

â¸»

âœ…ã€æœ€çµ‚è£œå¼·ã€‘è¿½åŠ ã™ã¹ãè¦³ç‚¹ï¼ˆ2025-07 å®Œå…¨æ”¹è¨‚ãƒ»è£œå¼·ç‰ˆï¼‰

â¸»

12. LLVMãƒ»JITãƒ»ä»®æƒ³ãƒ¡ãƒ¢ãƒªãƒ»OSã‚«ãƒ¼ãƒãƒ«è¨­è¨ˆã¨ã®é€£æºè¦–ç‚¹

é …ç›®	è£œè¶³å†…å®¹
Buddy Allocator ã®å°å…¥	OSã‚«ãƒ¼ãƒãƒ«ãƒ»glibcãƒ¬ãƒ™ãƒ«ã§æ¡ç”¨ã€‚ä»»æ„ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚ºã®2ã®å†ªã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œã€‚
Slab Allocator ã®å‚è€ƒè¨­è¨ˆ	ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†åˆ©ç”¨ã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼ˆä¾‹ï¼šds_stack_poolï¼‰
LLVM IR ã§ã® malloc è¡¨ç¾	llvm.memcpyãƒ»llvm.malloc ç³»ã¨ã®æ¥ç¶šè¦–ç‚¹ã€‚æœ€é©åŒ–ãƒ‘ã‚¹ã§ã®ãƒ¡ãƒ¢ãƒªç”Ÿå­˜æœŸé–“ã®æ¨è«–ã«ã‚‚é–¢ä¸ã€‚
GCè¨­è¨ˆã®åœŸå°	mark-and-sweepï¼reference counting ã§ã®æ‰€æœ‰æ¨©è¨­è¨ˆã®ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ allocator API æ‹¡å¼µãŒå¿…è¦ã€‚
ä»®æƒ³ãƒ¡ãƒ¢ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç†è§£	.text / .data / .bss / heap / stack ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ç©ºé–“ä¸Šã®é–¢ä¿‚ã¨mallocã®ãƒ’ãƒ¼ãƒ—å¢ƒç•Œè¨­è¨ˆï¼ˆbrk/sbrkï¼‰
å®Ÿè¡Œæ™‚ãƒ¡ãƒ¢ãƒªåœ§ç¸®ã®è¨­è¨ˆè¦–ç‚¹	ä¾‹ï¼šjemallocã®madviseã€Transparent Huge Pagesï¼ˆTHPï¼‰ã¨ã®é€£æºçŸ¥è­˜
JITå‘ã‘ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡	JITãŒç”Ÿæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰é ˜åŸŸã®å®Ÿè¡Œè¨±å¯ï¼ˆexecutable heapï¼‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å«ã‚€åˆ¶å¾¡å¿…è¦æ€§ã€‚


â¸»

13. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã®æœ€å‰ç·šè¦–ç‚¹

é …ç›®	è©³ç´°
Double Freeãƒ»UAF æ¤œçŸ¥	free() å¾Œã« NULL åŒ–ã™ã‚‹é˜²å¾¡ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€‚ã•ã‚‰ã« ds_free_secure() ã«ã‚ˆã‚Šç›£è¦–å¼·åŒ–å¯èƒ½ã€‚
Poisoning ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯	ãƒ’ãƒ¼ãƒ—è§£æ”¾å¾Œã®é ˜åŸŸã«ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆä¾‹ï¼š0xDEADBEEFï¼‰ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ã§ UAF æ¤œçŸ¥ã€‚
Fortify Source ã®æ´»ç”¨	-D_FORTIFY_SOURCE=2 ã«ã‚ˆã‚‹å¢ƒç•Œæ¤œçŸ¥ä»˜ãé–¢æ•°ã¸ã®è‡ªå‹•ç½®æ›ã€‚
Stack Canary å°å…¥	-fstack-protector-strong ã«ã‚ˆã‚‹ã‚¹ã‚¿ãƒƒã‚¯ãƒãƒƒãƒ•ã‚¡ç ´å£Šã®æ¤œçŸ¥ã€‚
Hardened malloc æ¦‚å¿µå°å…¥	glibc, musl ç­‰ã§æ¡ç”¨ã•ã‚Œã‚‹ã€Œmetadataåˆ†é›¢ã€ã€Œãƒ’ãƒ¼ãƒ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºã€è¦–ç‚¹å°å…¥ã€‚
ASLR (Address Space Layout Randomization)	malloc / mmap é ˜åŸŸã®ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºè€æ€§è¨­è¨ˆã€‚
Allocator Fault Injection	ãƒ†ã‚¹ãƒˆæ™‚ã«æ„å›³çš„ã« malloc å¤±æ•—ã‚’æ³¨å…¥ â†’ å„APIã® fail-safe ã‚’ãƒã‚°è€æ€§ CI ã§æ¤œè¨¼ã€‚


â¸»

14. ãƒ¡ãƒ¢ãƒªå¯è¦–åŒ–ã¨ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ­ã‚°å¼·åŒ–

æ©Ÿèƒ½	å®Ÿè£…å†…å®¹ä¾‹
ds_malloc_trace ãƒ¢ãƒ¼ãƒ‰	ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»ã‚µã‚¤ã‚ºãƒ»å‘¼ã³å‡ºã—å…ƒï¼ˆ__FILE__, __LINE__ï¼‰ãƒ­ã‚°ã‚’æ¨™æº–å‡ºåŠ› or ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ã€‚
JSONãƒ­ã‚°å‡ºåŠ›ã®åˆ‡ã‚Šæ›¿ãˆ	ds_set_log_format(JSON) ã§ãƒ­ã‚°å½¢å¼å¤‰æ›´ã€ELKé€£æºå¯èƒ½ã€‚
ãƒ¡ãƒ¢ãƒªãƒ’ãƒ¼ãƒ—ãƒãƒƒãƒ—å‡ºåŠ›	ds_dump_heap_map() ã«ã‚ˆã‚Šå…¨ä½“æ§‹é€ ã‚’å›³å½¢å¼å‡ºåŠ›ã€‚
mallocçµ±è¨ˆï¼ˆç´¯ç©/ç¾åœ¨ï¼‰	ç·mallocå›æ•°ã€å¤±æ•—å›æ•°ã€åˆè¨ˆãƒã‚¤ãƒˆæ•°ã€æœ€å¤§ãƒãƒ¼ã‚¹ãƒˆãªã©ã€‚


â¸»

15. æ•™è‚²ç†è«–ãƒ»ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ çµ±åˆï¼ˆå­¦ç¿’è€…ãƒ»å¾Œé€²è‚²æˆå¯¾å¿œï¼‰

é …ç›®	å†…å®¹
å¯è¦–åŒ–é‡è¦–ã®ãƒ¡ãƒ¢ãƒªã‚¢ãƒ­ã‚±ãƒ¼ã‚¿	mallocã®ãƒ’ãƒ¼ãƒ—é ˜åŸŸã‚’è‰²åˆ†ã‘å›³ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯è¦–åŒ–ï¼ˆæ•™è‚²å‘ã‘ãƒ“ãƒ«ãƒ‰ï¼‰
undo/redo ã‚’æœ‰é™ã‚ªãƒ¼ãƒˆãƒãƒˆãƒ³ã§å›³ç¤º	çŠ¶æ…‹é·ç§»ï¼ˆpush/popï¼‰ã‚’ DFA çŠ¶æ…‹é·ç§»è¡¨ãƒ»å›³ã§è¡¨ç¾
æ§‹é€ ä½“ã® ABIãƒ»alignment ã‚’å›³ã§è§£èª¬	offsetof, alignof, padding ã‚’ãƒ“ãƒƒãƒˆå˜ä½å›³è§£
pointer ownership ã‚’è‰²ä»˜ãç·šã§è§£èª¬	call graph + æ‰€æœ‰é–¢ä¿‚ï¼ˆownership mapï¼‰ã‚’ SVG ã§å‡ºåŠ›


â¸»

16. å½¢å¼æ‰‹æ³•ãƒ»è¨¼æ˜ãƒ»é™çš„è§£æã¾ã§ã®æœ€çµ‚å±•é–‹

æŠ€æ³•	è§£èª¬
Frama-C ã®å°å…¥	Hoareè«–ç†ãƒ™ãƒ¼ã‚¹ã§ C ã®ãƒã‚¤ãƒ³ã‚¿å®‰å…¨æ€§ï¼ãƒ’ãƒ¼ãƒ—ç ´å£Šãƒã‚§ãƒƒã‚¯å¯èƒ½
CBMC ã®ãƒ¢ãƒ‡ãƒ«æ¤œæŸ»	çŠ¶æ…‹é·ç§»ï¼ˆundo/redo, ã‚¹ã‚¿ãƒƒã‚¯æº¢ã‚Œï¼‰ã«å¯¾ã—å…¨æ¢ç´¢ã§ã®æ­»æ´»æ¤œè¨¼
MISRA-C å¯¾å¿œ	åŒ»ç™‚ãƒ»è‡ªå‹•è»Šæ¥­ç•Œã®é™çš„ã‚³ãƒ¼ãƒ‰ãƒ«ãƒ¼ãƒ«ã€‚ãƒ«ãƒ¼ãƒ«é©åˆã‚’ cppcheck ã§è‡ªå‹•åŒ–
fuzzing å¯¾å¿œ	AFL++ ã«ã‚ˆã‚‹ heap overflow / use-after-free ãªã©æœªå®šç¾©å‹•ä½œã®ç™ºè¦‹

>>>>>>> feature

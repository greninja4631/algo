# .github/workflows/ci.yml
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  ğŸŒ 2025-Ready CIâ€Š/â€ŠCD Pipeline  â€•  Linux/arm64 & amd64 ä¸¡å¯¾å¿œ
#     * buildx + QEMU ã§ã‚¯ãƒ­ã‚¹ãƒ“ãƒ«ãƒ‰
#     * lint â†’ build â†’ unit-test â†’ memcheck â†’ artefact upload
#     * clang-tidy é™çš„è§£æã‚’ç‹¬ç«‹ã‚¸ãƒ§ãƒ–ã§å®Ÿæ–½
#     * main ãƒ–ãƒ©ãƒ³ãƒå®Œäº†æ™‚ã« Jenkins ã‚‚ã‚­ãƒƒã‚¯
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: CI (multi-arch + clang-tidy)

on:
  push:
    branches: [ main, pre, feature ]
  pull_request:

env:
  DOCKER_CONTEXT: .
  DOCKERFILE: docker/Dockerfile
  TAG_PREFIX: yourapp:test       # platform æ–‡å­—åˆ—ã‚’å¾Œã‚ã«ä»˜ä¸

jobs:
# ============================================================
# 1ï¸âƒ£ Build & Test  ï¼ˆmatrix = amd64 / arm64ï¼‰
# ============================================================
  build-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    steps:
    # 1. ã‚½ãƒ¼ã‚¹å–å¾—
    - uses: actions/checkout@v4

    # 2. QEMU / buildx ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - uses: docker/setup-qemu-action@v3
    - uses: docker/setup-buildx-action@v3

    # 3. buildx ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ â€œãƒ­ãƒ¼ã‚«ãƒ«ã« LOADâ€
    - uses: docker/build-push-action@v5
      with:
        context: ${{ env.DOCKER_CONTEXT }}
        file:    ${{ env.DOCKERFILE }}
        platforms: ${{ matrix.platform }}
        tags: ${{ env.TAG_PREFIX }}-${{ matrix.platform }}
        load: true
        cache-from: type=gha
        cache-to:   type=gha,mode=max   # ãƒ¬ã‚¤ãƒ¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥å…±æœ‰ï¼ˆä»»æ„ï¼‰

    # 4. ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    - name: Run unit tests in container
      run: |
        docker run --rm ${{ env.TAG_PREFIX }}-${{ matrix.platform }}

    # 5. Valgrind ãƒ¡ãƒ¢ãƒªãƒã‚§ãƒƒã‚¯ï¼ˆå¤±æ•—ã¯ CI Failï¼‰
    - name: Run Valgrind (memcheck)
      run: |
        docker run --rm \
          --entrypoint valgrind \
          ${{ env.TAG_PREFIX }}-${{ matrix.platform }} \
          --leak-check=full /app/bin/main

    # 6. artefact ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆmain ãƒã‚¤ãƒŠãƒªã‚„ junit XML ãªã©ï¼‰
    - uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.platform }}
        path: build/

    # 7. main ãƒ–ãƒ©ãƒ³ãƒæ™‚ã®ã¿ Jenkins ã‚‚ãƒˆãƒªã‚¬ãƒ¼
    - name: Trigger Jenkins job
      if: ${{ github.ref == 'refs/heads/main' }}
      env:
        JENKINS_TOKEN: ${{ secrets.JENKINS_TOKEN }}
      run: |
        curl -s -X POST "https://your-jenkins-domain/job/your-job-name/build?token=${JENKINS_TOKEN}"

# ============================================================
# 2ï¸âƒ£ clang-tidy é™çš„è§£æ  ï¼ˆã‚½ãƒ¼ã‚¹ã®ã¿å¯¾è±¡ï¼‰
# ============================================================
  clang-tidy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install clang-tidy
      run: sudo apt-get update && sudo apt-get install -y clang-tidy

    - name: Run clang-tidy (all warnings â†’ error)
      run: |
        find src/ include/ -type f \( -name '*.c' -o -name '*.h' \) > files.txt
        # -quiet ã§è­¦å‘Šã®ã¿è¡¨ç¤ºã€--warnings-as-errors='*' ã§ 1 è­¦å‘Šã§ã‚‚ Fail
        clang-tidy --quiet --warnings-as-errors='*' \
          -p . $(cat files.txt)

# ============================================================
# 3ï¸âƒ£ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“çµæœã¾ã¨ã‚
# ============================================================
  summary:
    needs: [build-test, clang-tidy]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Print CI summary
      run: |
        echo "ğŸ“  Build-&-Test:  ${{ needs.build-test.result }}"
        echo "ğŸ“  clang-tidy:   ${{ needs.clang-tidy.result }}"

        
# =========================================================
# 2025-Ready  Multi-Arch Dockerfile  (GLIBC 2.38 / bookworm)
# =========================================================
# â–¶ï¸ arm64 / amd64 ã‚’åŒä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ“ãƒ«ãƒ‰å¯èƒ½
# â–¶ï¸ scripts/ci_tasks.sh ã‹ã‚‰ã‚‚ç›´æ¥å‘¼ã³å‡ºã—ã‚„ã™ã„

# BuildKit æ©Ÿèƒ½ã‚’ä½¿ã†å®£è¨€       â˜… ã“ã‚ŒãŒç„¡ã„ã¨ $TARGETPLATFORM ãŒåŠ¹ã‹ãªã„
# syntax=docker/dockerfile:1.4

################## ğŸ”¨  Build Stage  ##################
ARG TARGETPLATFORM     # â˜… FROM ã®å‰ã§å®£è¨€å¿…é ˆ
FROM --platform=$TARGETPLATFORM gcc:12-bookworm AS builder   

WORKDIR /app
COPY . .

RUN rm -rf build/ docs/ coverage/ \
 && chmod +x ./scripts/*.sh ./run_ci.sh || true \
 && ./scripts/lint.sh \
 && ./scripts/build.sh \
 && test -f build/bin/main \
 && chmod +x build/bin/main

################## ğŸ§ª  (optional) CI Stage ############
FROM builder AS ci
RUN ./run_ci.sh

################## ğŸš€  Production Stage  ##############
ARG TARGETPLATFORM
FROM --platform=$TARGETPLATFORM debian:bookworm-slim AS prod   

WORKDIR /app
COPY --from=builder /app/build/bin /app/bin
# RUN strip /app/bin/main   # ã‚µã‚¤ã‚ºã‚’å‰Šã‚ŠãŸã„å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
ENTRYPOINT ["/app/bin/main"]
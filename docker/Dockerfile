# =========================
# ğŸ—ï¸ GAFAæµãƒ»å®Œå…¨æˆæœç‰©ä¿è¨¼ Dockerfileã€2025å¹´æœ€æ–°ç‰ˆãƒ»multiarchå¯¾å¿œã€‘
# =========================

# -------- Build Stageï¼ˆmultiarchä¸¡å¯¾å¿œï¼‰ --------
FROM gcc:12 AS builder     
WORKDIR /app

# ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚³ãƒ”ãƒ¼
COPY . .

# ãƒ“ãƒ«ãƒ‰å‰ã«å…¨æˆæœç‰©ã‚’å®Œå…¨æ¶ˆå»
RUN rm -rf build/ docs/ coverage/

# å…¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å¿…ãšå®Ÿè¡Œå¯èƒ½åŒ–
RUN chmod +x ./scripts/*.sh ./run_ci.sh || true

# Lint + Build + mainãƒã‚¤ãƒŠãƒªå­˜åœ¨ãƒã‚§ãƒƒã‚¯
RUN ./scripts/lint.sh && ./scripts/build.sh \
 && echo "------ build/bin/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª ------" \
 && ls -lh build/bin || echo "build/bin ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç„¡ã—" \
 && [ -d build/bin ] || (echo "âŒ build/bin ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç„¡ã„ï¼" && exit 1) \
 && [ -f build/bin/main ] && chmod +x build/bin/main || (echo "âŒ mainãƒã‚¤ãƒŠãƒªãŒç„¡ã„ï¼ãƒ“ãƒ«ãƒ‰å¤±æ•—ï¼" && exit 1)

# -------- ğŸ§ª CI/CD Stageï¼ˆå¿…è¦ãªå ´åˆã ã‘ï¼‰ --------
FROM builder AS ci
RUN ./run_ci.sh

# -------- Production Stageï¼ˆmultiarchä¸¡å¯¾å¿œï¼‰ --------
FROM debian:bullseye-slim AS prod   
WORKDIR /app
COPY --from=builder /app/build/bin /app/bin

# æœ¬ç•ªãƒã‚¤ãƒŠãƒªã®å”¯ä¸€ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
ENTRYPOINT ["/app/bin/main"]
# =========================
# ğŸ—ï¸ GAFAæµãƒ»å®Œå…¨æˆæœç‰©ä¿è¨¼ Dockerfile
# =========================

FROM arm64v8/gcc:13 AS builder
WORKDIR /app

# ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚³ãƒ”ãƒ¼
COPY . .

# å…¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å¿…ãšå®Ÿè¡Œå¯èƒ½åŒ–
RUN chmod +x ./scripts/*.sh ./run_ci.sh

# Lintï¼ˆé™çš„è§£æï¼‰+ Buildï¼ˆMakefileï¼‰+ æˆæœç‰©(ãƒã‚¤ãƒŠãƒª)æ¤œè¨¼ï¼ˆlsï¼‰
RUN ./scripts/lint.sh && ./scripts/build.sh \
 && ls -l build/bin/ \
 && [ -f build/bin/main ] || (echo "mainãƒã‚¤ãƒŠãƒªãŒç„¡ã„ï¼Makefile/ãƒ“ãƒ«ãƒ‰å¤±æ•—ï¼ãƒ‘ã‚¹è¨­å®šãƒ».dockerignoreæ¼ã‚Œç­‰ã‚’å†ç¢ºèªï¼" && exit 1)

FROM builder AS ci
RUN ./run_ci.sh

FROM arm64v8/debian:bullseye-slim AS prod
WORKDIR /app
COPY --from=builder /app/build/bin /app/bin
ENTRYPOINT ["/app/bin/main"]